# CLAUDE.md

This is the official Cloudflare Python SDK (`cloudflare-python`), providing typed access to the Cloudflare REST API. Most code is auto-generated by Stainless from an OpenAPI spec. Only `src/cloudflare/lib/` and `examples/` are safe to edit manually — everything else gets overwritten on regeneration.

## Setup

```bash
# With Rye (recommended)
rye sync --all-features
rye shell  # or: source .venv/bin/activate

# Without Rye (requires Python 3.9.18, see .python-version)
python -m venv .venv && source .venv/bin/activate
pip install -r requirements-dev.lock
```

## Common Commands

```bash
# Lint (ruff + pyright + mypy)
rye run lint

# Format (ruff format + fix)
rye run format

# Type checking only
rye run typecheck            # pyright + mypy
rye run typecheck:pyright    # pyright only
rye run typecheck:mypy       # mypy only

# Run tests (starts a Prism mock server automatically if not running)
./scripts/test
# or directly:
rye run pytest

# Run a specific test file
rye run pytest tests/api_resources/test_dns.py

# Build
rye build
```

## Project Structure

- `src/cloudflare/` — Main SDK source (generated)
  - `resources/` — API resource modules (67 modules, e.g. dns, zones, accounts)
  - `types/` — Pydantic type definitions (~2400 files)
  - `lib/` — Manual library utilities (NOT generated, safe to edit)
  - `_client.py` — Main Cloudflare/AsyncCloudflare client
  - `_base_client.py` — Base HTTP client logic
  - `_models.py` — Pydantic model base classes
  - `_response.py` — Response handling
- `tests/` — Pytest test suite, organized by API resource
- `examples/` — Example scripts (NOT generated, safe to edit)
- `scripts/` — Dev scripts (test, lint, format, mock)

## Code Style

- **Line length**: 120 characters
- **Target Python**: 3.7+ (for compatibility), dev uses 3.9.18
- **Formatter**: Ruff (with ruff format)
- **Linter**: Ruff (isort, bugbear, unused imports, bare except, print statements)
- **Type checking**: Pyright (strict mode) + MyPy (strict)
- Print statements are flagged by the linter — don't add them in library code

## Testing

- Tests use `pytest` with `pytest-asyncio` (asyncio_mode = "auto")
- HTTP mocking via `respx`; API mocking via Prism (OpenAPI mock server on port 4010)
- `./scripts/test` auto-starts Prism if not already running
- Set `TEST_API_BASE_URL` env var to test against a custom endpoint
- `xfail_strict = true` — xfail-marked tests that unexpectedly pass will fail

## Key Patterns

- Sync client: `cloudflare.Cloudflare`, Async client: `cloudflare.AsyncCloudflare`
- Both clients share the same API surface; async methods are coroutines
- Pydantic v1 and v2 are both supported
- Resources are nested (e.g., `client.dns.records.list()`)
- Custom `lru_cache` in `_utils` should be used instead of `functools.lru_cache`
